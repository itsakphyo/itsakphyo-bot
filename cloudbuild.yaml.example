# Google Cloud Build configuration for deployment
# Copy this file to cloudbuild.yaml and update with your values

steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/your-bot-name:latest', '.']

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/your-bot-name:latest']

  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'your-bot-name'
      - '--image'
      - 'gcr.io/$PROJECT_ID/your-bot-name:latest'
      - '--region'
      - '$_REGION'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'
      - '--memory'
      - '1Gi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '1'
      - '--max-instances'
      - '10'
      - '--timeout'
      - '900'
      - '--set-env-vars'
      - 'ENVIRONMENT=production,HOST=0.0.0.0,GOOGLE_CLOUD_PROJECT_ID=$PROJECT_ID,GOOGLE_CLOUD_REGION=$_REGION,TOKEN=$_TOKEN,BOT_USERNAME=$_BOT_USERNAME,GOOGLE_DRIVE_FOLDER_ID=$_GOOGLE_DRIVE_FOLDER_ID,SECRET_KEY=$_SECRET_KEY'

images:
  - 'gcr.io/$PROJECT_ID/your-bot-name:latest'

# Substitutions for build variables
substitutions:
  _REGION: 'europe-west1'  # Your deployment region
  _TOKEN: ''  # Your Telegram bot token
  _BOT_USERNAME: ''  # Your bot username
  _GOOGLE_DRIVE_FOLDER_ID: ''  # Your Google Drive folder ID
  _SECRET_KEY: ''  # Your secret key

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# Instructions:
# 1. Copy this file to cloudbuild.yaml
# 2. Replace 'your-bot-name' with your actual bot name
# 3. Update substitution values
# 4. Deploy with: gcloud builds submit --config cloudbuild.yaml --substitutions=...
